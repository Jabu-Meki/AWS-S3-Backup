name: DEBUGGING - Backup CI/CD Pipeline

on:
  workflow_dispatch: {} # IMPORTANT: We are only using the manual trigger for this test.

jobs:
  validate:
    name: Lint and Validate Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v4
      - name: Lint Bash Script with ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './'

  build:
    name: Build & Push Docker Image
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      image_name: ${{ steps.set_image_name.outputs.IMAGE_NAME }}
    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v4
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # This is the original build step, we will leave it as is.
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/aws-s3-backup:latest,${{ secrets.DOCKERHUB_USERNAME }}/aws-s3-backup:${{ github.sha }}

      # --- DEBUG STEP 1: See what value we are trying to output ---
      - name: üïµÔ∏è DEBUG - Create and view the output value
        id: set_image_name
        run: |
          IMAGE_NAME_VALUE="${{ secrets.DOCKERHUB_USERNAME }}/aws-s3-backup:latest"
          echo "DEBUG BUILD JOB: The image name I am about to set as output is: '${IMAGE_NAME_VALUE}'"
          echo "IMAGE_NAME=${IMAGE_NAME_VALUE}" >> $GITHUB_OUTPUT

  run-backup:
    name: Run S3 Backup
    needs: build
    runs-on: ubuntu-latest
    steps:
      # --- DEBUG STEP 2: See what value we received from the build job ---
      - name: üïµÔ∏è DEBUG - Receive and view the output value
        run: |
          echo "DEBUG RUN JOB: The image name I received from the build job's output is: '${{ needs.build.outputs.image_name }}'"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with: 
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      # --- DEBUG STEP 3: We will use a hardcoded value to prove the rest of the job works ---
      - name: Run Backup Script with HARDCODED Image Name
        run: |
          echo "Attempting to run Docker with a hardcoded image name as a final test..."
          docker run --rm \
            -e AWS_ACCESS_KEY_ID \
            -e AWS_SECRET_ACCESS_KEY \
            -e AWS_SESSION_TOKEN \
            -e AWS_REGION \
            -e AWS_DEFAULT_REGION \
            -e SNS_TOPIC_ARN=${{ secrets.SNS_TOP_ARN }} \
            # --- HARDCODED VALUE BELOW ---
            jabu-meki/aws-s3-backup:latest \
            terraform-backup-test-mjay-sys